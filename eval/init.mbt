///|
let primitive_bindings : Array[(String, @core.Primitive)] = [
  ("+", Add),
  ("-", Sub),
  ("*", Mul),
  ("/", Div),
  ("=", NumEq),
  ("<", Less),
  (">", Greater),
  ("<=", LessEq),
  (">=", GreaterEq),
  ("cons", Cons),
  ("car", Car),
  ("cdr", Cdr),
  ("list", List),
  ("make-list", MakeList),
  ("null?", NullP),
  ("pair?", PairP),
  ("symbol?", SymbolP),
  ("symbol=?", SymbolEq),
  ("identifier?", IdentifierP),
  ("syntax?", SyntaxP),
  ("free-identifier=?", FreeIdentifierEq),
  ("bound-identifier=?", BoundIdentifierEq),
  ("symbol->string", SymbolToString),
  ("string->symbol", StringToSymbol),
  ("string-hash", StringHash),
  ("string-ci-hash", StringCiHash),
  ("symbol-hash", SymbolHash),
  ("equal-hash", EqualHash),
  ("syntax->datum", SyntaxToDatum),
  ("datum->syntax", DatumToSyntax),
  ("make-variable-transformer", MakeVariableTransformer),
  ("generate-temporaries", GenerateTemporaries),
  ("boolean?", BooleanP),
  ("boolean=?", BooleanEq),
  ("number?", NumberP),
  ("integer?", IntegerP),
  ("exact-integer?", ExactIntegerP),
  ("rational?", RationalP),
  ("real?", RealP),
  ("complex?", ComplexP),
  ("exact?", ExactP),
  ("inexact?", InexactP),
  ("zero?", ZeroP),
  ("positive?", PositiveP),
  ("negative?", NegativeP),
  ("odd?", OddP),
  ("even?", EvenP),
  ("finite?", FiniteP),
  ("infinite?", InfiniteP),
  ("nan?", NanP),
  ("procedure?", ProcedureP),
  ("record?", RecordP),
  ("record-rtd", RecordRtd),
  ("record-type-descriptor?", RecordTypeDescriptorP),
  ("record-constructor-descriptor?", RecordConstructorDescriptorP),
  ("record-type-name", RecordTypeName),
  ("record-type-parent", RecordTypeParent),
  ("record-type-uid", RecordTypeUid),
  ("record-type-generative?", RecordTypeGenerativeP),
  ("record-type-sealed?", RecordTypeSealedP),
  ("record-type-opaque?", RecordTypeOpaqueP),
  ("record-type-field-names", RecordTypeFieldNames),
  ("record-type-field-mutable?", RecordTypeFieldMutableP),
  ("record-constructor-descriptor", RecordConstructorDescriptor),
  ("record-constructor", RecordConstructor),
  ("record-predicate", RecordPredicate),
  ("record-accessor", RecordAccessor),
  ("record-mutator", RecordMutator),
  ("make-record-type-descriptor", MakeRecordTypeDescriptor),
  ("make-record-constructor-descriptor", MakeRecordConstructorDescriptor),
  ("condition", Condition),
  ("condition?", ConditionP),
  ("simple-conditions", SimpleConditions),
  ("condition-predicate", ConditionPredicate),
  ("condition-accessor", ConditionAccessor),
  ("make-eq-hashtable", MakeEqHashtable),
  ("make-eqv-hashtable", MakeEqvHashtable),
  ("make-hashtable", MakeHashtable),
  ("hashtable?", HashtableP),
  ("hashtable-size", HashtableSize),
  ("hashtable-ref", HashtableRef),
  ("hashtable-set!", HashtableSet),
  ("hashtable-delete!", HashtableDelete),
  ("hashtable-contains?", HashtableContainsP),
  ("hashtable-update!", HashtableUpdate),
  ("hashtable-copy", HashtableCopy),
  ("hashtable-clear!", HashtableClear),
  ("hashtable-keys", HashtableKeys),
  ("hashtable-entries", HashtableEntries),
  ("hashtable-equivalence-function", HashtableEquivalenceFunction),
  ("hashtable-hash-function", HashtableHashFunction),
  ("hashtable-mutable?", HashtableMutableP),
  ("make-enumeration", MakeEnumeration),
  ("enum-set-universe", EnumSetUniverse),
  ("enum-set-indexer", EnumSetIndexer),
  ("enum-set-constructor", EnumSetConstructor),
  ("enum-set?", EnumSetP),
  ("enum-set-member?", EnumSetMemberP),
  ("enum-set-subset?", EnumSetSubsetP),
  ("enum-set=?", EnumSetEq),
  ("enum-set-union", EnumSetUnion),
  ("enum-set-intersection", EnumSetIntersection),
  ("enum-set-difference", EnumSetDifference),
  ("enum-set-complement", EnumSetComplement),
  ("enum-set-projection", EnumSetProjection),
  ("enum-set->list", EnumSetToList),
  ("not", Not),
  ("apply", Apply),
  ("values", Values),
  ("call-with-values", CallWithValues),
  ("make-parameter", MakeParameter),
  ("dynamic-wind", DynamicWind),
  ("promise?", PromiseP),
  ("make-promise", MakePromise),
  ("force", Force),
  ("exact->inexact", ExactToInexact),
  ("inexact->exact", InexactToExact),
  ("exact-integer-sqrt", ExactIntegerSqrt),
  ("rationalize", Rationalize),
  ("number->string", NumberToString),
  ("string->number", StringToNumber),
  ("make-rectangular", MakeRectangular),
  ("make-polar", MakePolar),
  ("real-part", RealPart),
  ("imag-part", ImagPart),
  ("magnitude", Magnitude),
  ("angle", Angle),
  ("sqrt", Sqrt),
  ("exp", Exp),
  ("log", Log),
  ("expt", Expt),
  ("sin", Sin),
  ("cos", Cos),
  ("tan", Tan),
  ("asin", Asin),
  ("acos", Acos),
  ("atan", Atan),
  ("numerator", Numerator),
  ("denominator", Denominator),
  ("abs", Abs),
  ("quotient", Quotient),
  ("remainder", Remainder),
  ("modulo", Modulo),
  ("gcd", Gcd),
  ("lcm", Lcm),
  ("max", Max),
  ("min", Min),
  ("floor", Floor),
  ("ceiling", Ceiling),
  ("truncate", Truncate),
  ("round", Round),
  ("bitwise-and", BitwiseAnd),
  ("bitwise-ior", BitwiseIor),
  ("bitwise-xor", BitwiseXor),
  ("bitwise-not", BitwiseNot),
  ("bitwise-if", BitwiseIf),
  ("arithmetic-shift", ArithmeticShift),
  ("bitwise-bit-count", BitwiseBitCount),
  ("bitwise-length", BitwiseLength),
  ("bitwise-first-bit-set", BitwiseFirstBitSet),
  ("bitwise-bit-set?", BitwiseBitSetP),
  ("bitwise-copy-bit", BitwiseCopyBit),
  ("bitwise-bit-field", BitwiseBitField),
  ("bitwise-copy-bit-field", BitwiseCopyBitField),
  ("bitwise-rotate-bit-field", BitwiseRotateBitField),
  ("bitwise-reverse-bit-field", BitwiseReverseBitField),
  ("fixnum?", FixnumP),
  ("fixnum-width", FixnumWidth),
  ("least-fixnum", LeastFixnum),
  ("greatest-fixnum", GreatestFixnum),
  ("fx=?", FxEq),
  ("fx<?", FxLess),
  ("fx>?", FxGreater),
  ("fx<=?", FxLessEq),
  ("fx>=?", FxGreaterEq),
  ("fxzero?", FxZeroP),
  ("fxpositive?", FxPositiveP),
  ("fxnegative?", FxNegativeP),
  ("fxodd?", FxOddP),
  ("fxeven?", FxEvenP),
  ("fxmin", FxMin),
  ("fxmax", FxMax),
  ("fx+", FxAdd),
  ("fx-", FxSub),
  ("fx*", FxMul),
  ("fxdiv", FxDiv),
  ("fxmod", FxMod),
  ("fxdiv0", FxDiv0),
  ("fxmod0", FxMod0),
  ("fx+/carry", FxAddCarry),
  ("fx-/carry", FxSubCarry),
  ("fx*/carry", FxMulCarry),
  ("fxnot", FxNot),
  ("fxand", FxAnd),
  ("fxior", FxIor),
  ("fxxor", FxXor),
  ("fxif", FxIf),
  ("fxbit-count", FxBitCount),
  ("fxlength", FxLength),
  ("fxfirst-bit-set", FxFirstBitSet),
  ("fxbit-set?", FxBitSetP),
  ("fxcopy-bit", FxCopyBit),
  ("fxbit-field", FxBitField),
  ("fxcopy-bit-field", FxCopyBitField),
  ("fxrotate-bit-field", FxRotateBitField),
  ("fxreverse-bit-field", FxReverseBitField),
  ("fxarithmetic-shift", FxArithmeticShift),
  ("fxarithmetic-shift-left", FxArithmeticShiftLeft),
  ("fxarithmetic-shift-right", FxArithmeticShiftRight),
  ("flonum?", FlonumP),
  ("real->flonum", RealToFlonum),
  ("fixnum->flonum", FixnumToFlonum),
  ("fl=?", FlEq),
  ("fl<?", FlLess),
  ("fl>?", FlGreater),
  ("fl<=?", FlLessEq),
  ("fl>=?", FlGreaterEq),
  ("flinteger?", FlIntegerP),
  ("flzero?", FlZeroP),
  ("flpositive?", FlPositiveP),
  ("flnegative?", FlNegativeP),
  ("flodd?", FlOddP),
  ("fleven?", FlEvenP),
  ("flfinite?", FlFiniteP),
  ("flinfinite?", FlInfiniteP),
  ("flnan?", FlNanP),
  ("flmax", FlMax),
  ("flmin", FlMin),
  ("fl+", FlAdd),
  ("fl*", FlMul),
  ("fl-", FlSub),
  ("fl/", FlDiv),
  ("flabs", FlAbs),
  ("fldiv-and-mod", FlDivAndMod),
  ("fldiv", FlDivInt),
  ("flmod", FlMod),
  ("fldiv0-and-mod0", FlDiv0AndMod0),
  ("fldiv0", FlDiv0),
  ("flmod0", FlMod0),
  ("flnumerator", FlNumerator),
  ("fldenominator", FlDenominator),
  ("flfloor", FlFloor),
  ("flceiling", FlCeiling),
  ("fltruncate", FlTruncate),
  ("flround", FlRound),
  ("flexp", FlExp),
  ("fllog", FlLog),
  ("flsin", FlSin),
  ("flcos", FlCos),
  ("fltan", FlTan),
  ("flasin", FlAsin),
  ("flacos", FlAcos),
  ("flatan", FlAtan),
  ("flsqrt", FlSqrt),
  ("flexpt", FlExpt),
  ("eq?", Eq),
  ("eqv?", Eqv),
  ("equal?", Equal),
  ("list?", ListP),
  ("list-ref", ListRef),
  ("list-tail", ListTail),
  ("member", Member),
  ("memq", Memq),
  ("memv", Memv),
  ("assoc", Assoc),
  ("assq", Assq),
  ("assv", Assv),
  ("map", Map),
  ("for-each", ForEach),
  ("set-car!", SetCar),
  ("set-cdr!", SetCdr),
  ("list-copy", ListCopy),
  ("length", Length),
  ("append", Append),
  ("reverse", Reverse),
  ("char=?", CharEq),
  ("char<?", CharLess),
  ("char>?", CharGreater),
  ("char<=?", CharLessEq),
  ("char>=?", CharGreaterEq),
  ("char-ci=?", CharCiEq),
  ("char-ci<?", CharCiLess),
  ("char-ci>?", CharCiGreater),
  ("char-ci<=?", CharCiLessEq),
  ("char-ci>=?", CharCiGreaterEq),
  ("char?", CharP),
  ("char->integer", CharToInteger),
  ("integer->char", IntegerToChar),
  ("char-alphabetic?", CharAlphabeticP),
  ("char-numeric?", CharNumericP),
  ("char-whitespace?", CharWhitespaceP),
  ("char-upper-case?", CharUpperCaseP),
  ("char-lower-case?", CharLowerCaseP),
  ("char-upcase", CharUpcase),
  ("char-downcase", CharDowncase),
  ("char-foldcase", CharFoldcase),
  ("char-general-category", CharGeneralCategory),
  ("string=?", StringEq),
  ("string<?", StringLess),
  ("string>?", StringGreater),
  ("string<=?", StringLessEq),
  ("string>=?", StringGreaterEq),
  ("string-ci=?", StringCiEq),
  ("string-ci<?", StringCiLess),
  ("string-ci>?", StringCiGreater),
  ("string-ci<=?", StringCiLessEq),
  ("string-ci>=?", StringCiGreaterEq),
  ("string", String),
  ("make-string", MakeString),
  ("string?", StringP),
  ("string-length", StringLength),
  ("string-append", StringAppend),
  ("string-ref", StringRef),
  ("string-set!", StringSet),
  ("string-copy", StringCopy),
  ("substring", Substring),
  ("string-copy!", StringCopyBang),
  ("string-fill!", StringFill),
  ("string->list", StringToList),
  ("list->string", ListToString),
  ("string-map", StringMap),
  ("string-for-each", StringForEach),
  ("string-upcase", StringUpcase),
  ("string-downcase", StringDowncase),
  ("string-foldcase", StringFoldcase),
  ("string-normalize-nfc", StringNormalizeNfc),
  ("string-normalize-nfd", StringNormalizeNfd),
  ("string-normalize-nfkc", StringNormalizeNfkc),
  ("string-normalize-nfkd", StringNormalizeNfkd),
  ("vector", Vector),
  ("make-vector", MakeVector),
  ("vector?", VectorP),
  ("vector-length", VectorLength),
  ("vector-ref", VectorRef),
  ("vector-set!", VectorSet),
  ("vector-fill!", VectorFill),
  ("vector-copy", VectorCopy),
  ("vector-copy!", VectorCopyBang),
  ("vector-append", VectorAppend),
  ("vector-map", VectorMap),
  ("vector-for-each", VectorForEach),
  ("vector->list", VectorToList),
  ("list->vector", ListToVector),
  ("bytevector", ByteVector),
  ("make-bytevector", MakeByteVector),
  ("bytevector?", ByteVectorP),
  ("bytevector-length", ByteVectorLength),
  ("bytevector=?", ByteVectorEq),
  ("bytevector-u8-ref", ByteVectorU8Ref),
  ("bytevector-u8-set!", ByteVectorU8Set),
  ("bytevector-copy", ByteVectorCopy),
  ("bytevector-copy!", ByteVectorCopyBang),
  ("bytevector-append", ByteVectorAppend),
  ("bytevector-fill!", ByteVectorFill),
  ("bytevector->u8-list", ByteVectorToU8List),
  ("u8-list->bytevector", U8ListToByteVector),
  ("string->utf8", StringToUtf8),
  ("utf8->string", Utf8ToString),
  ("native-endianness", NativeEndianness),
  ("bytevector-uint-ref", ByteVectorUintRef),
  ("bytevector-sint-ref", ByteVectorSintRef),
  ("bytevector-uint-set!", ByteVectorUintSet),
  ("bytevector-sint-set!", ByteVectorSintSet),
  ("display", Display),
  ("write", Write),
  ("newline", Newline),
  ("open-output-string", OpenOutputString),
  ("get-output-string", GetOutputString),
  ("current-output-port", CurrentOutputPort),
  ("with-exception-handler", WithExceptionHandler),
  ("raise", Raise),
  ("raise-continuable", RaiseContinuable),
  ("error", Error),
  ("assertion-violation", AssertionViolation),
  ("implementation-restriction-violation", ImplementationRestrictionViolation),
  ("undefined-violation", UndefinedViolation),
  ("syntax-violation", SyntaxViolation),
  ("call/cc", CallCC),
  ("call-with-current-continuation", CallCC),
  ("eval", Eval),
  ("environment", Environment),
]

///|
let cxr_chains : Array[String] = [
  "aa", "ad", "da", "dd", "aaa", "aad", "ada", "add", "daa", "dad", "dda", "ddd",
  "aaaa", "aaad", "aada", "aadd", "adaa", "adad", "adda", "addd", "daaa", "daad",
  "dada", "dadd", "ddaa", "ddad", "ddda", "dddd",
]

///|
fn define_primitives(
  env : @core.Env,
  defs : Array[(String, @core.Primitive)],
) -> Unit {
  for i = 0; i < defs.length(); {
    // invariant : i >= 0 && i <= defs.length()
    // decreases : defs.length() - i
    // assert : i <= defs.length()
    let (name, prim) = defs[i]
    @runtime.env_define(env, name, Primitive(prim))
    continue i + 1
  } nobreak {
    ()
  }
}

///|
fn define_cxr_primitives(env : @core.Env) -> Unit {
  for chain in cxr_chains {
    @runtime.env_define(env, "c\{chain}r", Primitive(Cxr(chain)))
  }
}

///|
fn init_env() -> @core.Env {
  let env = @runtime.env_new()
  let condition_rtd = match
    @runtime.lookup_record_type_descriptor("&condition") {
    Some(desc) => desc
    None => {
      let condition_type = @runtime.make_record_type(
        "&condition",
        None,
        false,
        false,
        None,
        [],
      )
      let condition_ctor_desc = @runtime.make_record_constructor_descriptor(
        condition_type,
        None,
        None,
      )
      let condition_rtd = @runtime.make_record_type_descriptor(
        condition_type, condition_ctor_desc,
      )
      let _ = @runtime.register_record_type("&condition", condition_rtd)
      condition_rtd
    }
  }
  @runtime.env_define(env, "&condition", RecordTypeDescriptor(condition_rtd))
  define_primitives(env, primitive_bindings)
  define_cxr_primitives(env)
  env
}

///|
fn env_export_map(env : @core.Env) -> Map[String, @core.Binding] {
  let exports : Map[String, @core.Binding] = {}
  for frame in env {
    frame.iter2().each((key, binding) => exports[key] = binding)
  }
  exports
}
